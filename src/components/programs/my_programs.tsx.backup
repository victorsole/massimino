'use client';

import React from 'react';
import Link from 'next/link';
import {
  UserProgram,
  ProgramCategory,
  PROGRAM_CATEGORY_COLORS,
  getProgramHeroImage,
} from '@/types/program';

interface MyProgramsProps {
  programs: UserProgram[];
  onAddProgram?: () => void;
}

const CATEGORY_ICONS: Record<ProgramCategory, string> = {
  celebrity: 'mdi-star',
  goal: 'mdi-fire',
  lifestyle: 'mdi-heart-pulse',
  sport: 'mdi-basketball',
  modality: 'mdi-dumbbell',
};

const CATEGORY_LABELS: Record<ProgramCategory, string> = {
  celebrity: 'Celebrity',
  goal: 'Goal',
  lifestyle: 'Lifestyle',
  sport: 'Sport',
  modality: 'Modality',
};

export function MyPrograms({ programs, onAddProgram }: MyProgramsProps) {
  return (
    <div className="max-w-[1400px] mx-auto px-5 py-10">
      <div className="mb-8">
        <h1 className="text-3xl font-extrabold text-gray-900 mb-2">My Programs</h1>
        <p className="text-gray-500">
          {programs.length > 0
            ? `You are following ${programs.length} program${programs.length > 1 ? 's' : ''}. Keep up the great work!`
            : 'Start your fitness journey by adding a program.'}
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {programs.map((userProgram) => (
          <ProgramCard key={userProgram.subscription.id} userProgram={userProgram} />
        ))}

        {/* Add Program Card */}
        <button
          onClick={onAddProgram}
          className="bg-white border-2 border-dashed border-gray-200 rounded-2xl flex flex-col items-center justify-center min-h-[280px] transition-all hover:border-[#254967] hover:bg-[#fcf8f2] cursor-pointer"
        >
          <span className="mdi mdi-plus-circle-outline text-5xl text-gray-400 mb-3" />
          <span className="text-base font-semibold text-gray-400">Add Another Program</span>
        </button>
      </div>
    </div>
  );
}

interface ProgramCardProps {
  userProgram: UserProgram;
}

function ProgramCard({ userProgram }: ProgramCardProps) {
  const { subscription, program, next_workout } = userProgram;

  // Determine category from program
  const category: ProgramCategory = program.program_philosophy?.athlete_info
    ? 'celebrity'
    : program.sport_demands
    ? 'sport'
    : 'goal';

  const colors = PROGRAM_CATEGORY_COLORS[category];
  const heroImage = getProgramHeroImage(program.metadata.program_id);

  const progressPercentage = Math.round(subscription.progress_percentage);
  const currentWeek = subscription.current_week;
  const totalWeeks = program.metadata.duration_weeks;

  return (
    <Link
      href={`/workout-log/programs/${subscription.program_id}`}
      className="bg-white rounded-2xl overflow-hidden shadow-sm transition-all hover:shadow-lg hover:-translate-y-1"
    >
      {/* Hero Section */}
      <div
        className="p-6 text-white relative overflow-hidden"
        style={{
          background: heroImage
            ? `linear-gradient(135deg, ${colors.gradient_start} 0%, ${colors.gradient_end} 100%)`
            : `linear-gradient(135deg, ${colors.gradient_start.replace('0.82', '1')} 0%, ${colors.gradient_end.replace('0.82', '1')} 100%)`,
        }}
      >
        {heroImage && (
          <div
            className="absolute inset-0 bg-cover bg-center opacity-30"
            style={{ backgroundImage: `url(${heroImage})` }}
          />
        )}
        <div className="relative z-10">
          <div className="inline-flex items-center gap-1.5 bg-white/20 px-2.5 py-1 rounded-full text-xs font-semibold mb-3">
            <span className={`mdi ${CATEGORY_ICONS[category]} text-sm`} />
            {CATEGORY_LABELS[category]}
          </div>
          <div className="text-xl font-bold mb-1">{program.metadata.program_name}</div>
          <div className="text-sm opacity-90">
            {program.metadata.methodology || program.metadata.goal}
          </div>
        </div>

        {/* Progress Circle */}
        <div className="absolute top-4 right-4 w-12 h-12 rounded-full bg-white/20 flex items-center justify-center text-sm font-bold">
          {progressPercentage}%
        </div>
      </div>

      {/* Body Section */}
      <div className="p-5">
        {/* Stats */}
        <div className="flex gap-5 mb-4">
          <div className="flex items-center gap-1.5 text-sm text-gray-500">
            <span className="mdi mdi-calendar-check text-[#254967]" />
            Week {currentWeek} of {totalWeeks}
          </div>
          <div className="flex items-center gap-1.5 text-sm text-gray-500">
            <span className="mdi mdi-dumbbell text-[#254967]" />
            {program.metadata.frequency_per_week} days/week
          </div>
        </div>

        {/* Next Workout */}
        {next_workout && (
          <div className="bg-[#fcf8f2] rounded-lg p-3 flex items-center justify-between">
            <div>
              <div className="text-xs text-gray-500 uppercase tracking-wide">
                Next Workout
              </div>
              <div className="text-sm font-semibold text-gray-900">
                {next_workout.name}
              </div>
            </div>
            <span className="mdi mdi-chevron-right text-[#254967]" />
          </div>
        )}
      </div>
    </Link>
  );
}

export default MyPrograms;
